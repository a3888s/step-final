name: Build and Push Docker Image  # Назва GitHub Workflow

on:
  push:                             # Виконувати Workflow при пушах
    branches:
      - dev                         # Тільки для гілки "dev"

jobs:
  build:
    runs-on: ubuntu-latest          # Виконувати на останній версії Ubuntu
    env:
      DOCKER_TAG: v0.0.1  # Задати тег
    steps:
      - name: Checkout code         # Крок для завантаження коду репозиторію
        uses: actions/checkout@v3   # Офіційний GitHub Action для checkout

      - name: Login to Docker Hub   # Логін у Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Ім'я користувача з GitHub Secrets
          password: ${{ secrets.DOCKERHUB_TOKEN }}     # Токен з GitHub Secrets

      - name: Build Docker Image    # Побудова Docker-образу
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/step-final-project:${DOCKER_TAG} -f app/Dockerfile app/

      - name: Push Docker Image     # Завантаження Docker-образу в Docker Hub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/step-final-project:${DOCKER_TAG}

      - name: Replace DOCKER_TAG in DEV deployment.yaml
        run: |
          envsubst < app/k8s/dev/deployment.yaml > deployment.yaml

      - name: Replace DOCKER_TAG in PROD deployment.yaml
        run: |
          envsubst < app/k8s/prod/deployment.yaml > deployment.yaml

      - name: Lint Kubernetes YAML
        run: |
          yamllint app/k8s/dev/deployment.yaml
          yamllint app/k8s/prod/deployment.yaml